<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/modules/dropdown.js | tablefilter v0.1.15 API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/koalyptus/TableFilter.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/emitter.js~Emitter.html">Emitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tablefilter.js~TableFilter.html">TableFilter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">extensions/advancedGrid</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/extensions/advancedGrid/adapterEzEditTable.js~AdapterEzEditTable.html">AdapterEzEditTable</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">extensions/colOps</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/extensions/colOps/colOps.js~ColOps.html">ColOps</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">extensions/colsVisibility</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/extensions/colsVisibility/colsVisibility.js~ColsVisibility.html">ColsVisibility</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">extensions/filtersVisibility</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/extensions/filtersVisibility/filtersVisibility.js~FiltersVisibility.html">FiltersVisibility</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">extensions/sort</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/extensions/sort/adapterSortabletable.js~AdapterSortableTable.html">AdapterSortableTable</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">modules</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/alternateRows.js~AlternateRows.html">AlternateRows</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/checkList.js~CheckList.html">CheckList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/clearButton.js~ClearButton.html">ClearButton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/dropdown.js~Dropdown.html">Dropdown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/feature.js~Feature.html">Feature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/gridLayout.js~GridLayout.html">GridLayout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/help.js~Help.html">Help</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/highlightKeywords.js~HighlightKeyword.html">HighlightKeyword</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/loader.js~Loader.html">Loader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/noResults.js~NoResults.html">NoResults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/paging.js~Paging.html">Paging</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/popupFilter.js~PopupFilter.html">PopupFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/rowsCounter.js~RowsCounter.html">RowsCounter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/statusBar.js~StatusBar.html">StatusBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/modules/store.js~Store.html">Store</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/modules/dropdown.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {Feature} from &apos;./feature&apos;;
import Dom from &apos;../dom&apos;;
import Arr from &apos;../array&apos;;
import Str from &apos;../string&apos;;
import Sort from &apos;../sort&apos;;
import Event from &apos;../event&apos;;

const SORT_ERROR = &apos;Filter options for column {0} cannot be sorted in &apos; +
    &apos;{1} manner.&apos;;

export class Dropdown extends Feature{

    /**
     * Dropdown UI component
     * @param {Object} tf TableFilter instance
     */
    constructor(tf){
        super(tf, &apos;dropdown&apos;);

        // Configuration object
        let f = tf.config();

        this.enableSlcResetFilter = f.enable_slc_reset_filter===false ?
            false : true;
        //defines empty option text
        this.nonEmptyText = f.non_empty_text || &apos;(Non empty)&apos;;
        //IE only, tooltip text appearing on select before it is populated
        this.activateSlcTooltip = f.activate_slc_tooltip ||
            &apos;Click to activate&apos;;
        //tooltip text appearing on multiple select
        this.multipleSlcTooltip = f.multiple_slc_tooltip ||
            &apos;Use Ctrl key for multiple selections&apos;;

        this.isCustom = null;
        this.opts = null;
        this.optsTxt = null;
        this.slcInnerHtml = null;
    }

    onSlcFocus(e) {
        let elm = Event.target(e);
        let tf = this.tf;
        tf.activeFilterId = elm.getAttribute(&apos;id&apos;);
        tf.activeFlt = Dom.id(tf.activeFilterId);
        // select is populated when element has focus
        if(tf.loadFltOnDemand &amp;&amp; elm.getAttribute(&apos;filled&apos;) === &apos;0&apos;){
            let ct = elm.getAttribute(&apos;ct&apos;);
            this.build(ct);
        }
        this.emitter.emit(&apos;filter-focus&apos;, tf, this);
    }

    onSlcChange() {
        if(this.tf.onSlcChange){
            this.tf.filter();
        }
    }

    /**
     * Initialize drop-down filter
     * @param  {Number}     colIndex   Column index
     * @param  {Boolean}    isExternal External filter flag
     * @param  {DOMElement} container  Dom element containing the filter
     */
    init(colIndex, isExternal, container){
        let tf = this.tf;
        let col = tf.getFilterType(colIndex);
        let externalFltTgtId = isExternal ?
            tf.externalFltTgtIds[colIndex] : null;

        let slc = Dom.create(tf.fltTypeSlc,
            [&apos;id&apos;, tf.prfxFlt+colIndex+&apos;_&apos;+tf.id],
            [&apos;ct&apos;, colIndex], [&apos;filled&apos;, &apos;0&apos;]
        );

        if(col === tf.fltTypeMulti){
            slc.multiple = tf.fltTypeMulti;
            slc.title = this.multipleSlcTooltip;
        }
        slc.className = Str.lower(col) === tf.fltTypeSlc ?
            tf.fltCssClass : tf.fltMultiCssClass;

        //filter is appended in container element
        if(externalFltTgtId){
            Dom.id(externalFltTgtId).appendChild(slc);
            tf.externalFltEls.push(slc);
        } else {
            container.appendChild(slc);
        }

        tf.fltIds.push(slc.id);

        if(!tf.loadFltOnDemand){
            this.build(colIndex);
        } else {
            //1st option is created here since build isn&apos;t invoked
            let opt0 = Dom.createOpt(tf.displayAllText, &apos;&apos;);
            slc.appendChild(opt0);
        }

        Event.add(slc, &apos;change&apos;, ()=&gt; this.onSlcChange());
        Event.add(slc, &apos;focus&apos;, (e)=&gt; this.onSlcFocus(e));

        this.emitter.on(
            [&apos;build-select-filter&apos;],
            (tf, colIndex, isLinked, isExternal)=&gt;
                this.build(colIndex, isLinked, isExternal)
        );
        this.emitter.on(
            [&apos;select-options&apos;],
            (tf, colIndex, values)=&gt; this.selectOptions(colIndex, values)
        );

        this.initialized = true;
    }

    /**
     * Build drop-down filter UI
     * @param  {Number}  colIndex    Column index
     * @param  {Boolean} isLinked    Enable linked refresh behaviour
     * @param  {Boolean} isExternal  Render in external container
     * @param  {String}  extSlcId    External container id
     */
    build(colIndex, isLinked=false, isExternal=false, extSlcId=null){
        let tf = this.tf;
        colIndex = parseInt(colIndex, 10);

        this.emitter.emit(&apos;before-populating-filter&apos;, tf, colIndex);

        this.opts = [];
        this.optsTxt = [];
        this.slcInnerHtml = &apos;&apos;;

        let slcId = tf.fltIds[colIndex];
        if((!Dom.id(slcId) &amp;&amp; !isExternal) ||
            (!Dom.id(extSlcId) &amp;&amp; isExternal)){
            return;
        }
        let slc = !isExternal ? Dom.id(slcId) : Dom.id(extSlcId),
            rows = tf.tbl.rows,
            matchCase = tf.matchCase;

        //custom select test
        this.isCustom = tf.isCustomOptions(colIndex);

        //custom selects text
        let activeFlt;
        if(isLinked &amp;&amp; tf.activeFilterId){
            activeFlt = tf.activeFilterId.split(&apos;_&apos;)[0];
            activeFlt = activeFlt.split(tf.prfxFlt)[1];
        }

        let excludedOpts = null,
            filteredDataCol = null;
        if(isLinked &amp;&amp; tf.disableExcludedOptions){
            excludedOpts = [];
            filteredDataCol = [];
        }

        for(let k=tf.refRow; k&lt;tf.nbRows; k++){
            // always visible rows don&apos;t need to appear on selects as always
            // valid
            if(tf.hasVisibleRows &amp;&amp; tf.visibleRows.indexOf(k) !== -1){
                continue;
            }

            let cell = rows[k].cells,
                nchilds = cell.length;

            // checks if row has exact cell #
            if(nchilds !== tf.nbCells || this.isCustom){
                continue;
            }

            // this loop retrieves cell data
            for(let j=0; j&lt;nchilds; j++){
                // WTF: cyclomatic complexity hell
                if((colIndex===j &amp;&amp;
                    (!isLinked ||
                        (isLinked &amp;&amp; tf.disableExcludedOptions))) ||
                    (colIndex==j &amp;&amp; isLinked &amp;&amp;
                        ((rows[k].style.display === &apos;&apos; &amp;&amp; !tf.paging) ||
                    (tf.paging &amp;&amp; (!tf.validRowsIndex ||
                        (tf.validRowsIndex &amp;&amp;
                            tf.validRowsIndex.indexOf(k) != -1)) &amp;&amp;
                        ((activeFlt===undefined || activeFlt==colIndex) ||
                            (activeFlt!=colIndex &amp;&amp;
                                tf.validRowsIndex.indexOf(k) != -1 ))) ))){
                    let cell_data = tf.getCellData(cell[j]),
                        //Vary Peter&apos;s patch
                        cell_string = Str.matchCase(cell_data, matchCase);

                    // checks if celldata is already in array
                    if(!Arr.has(this.opts, cell_string, matchCase)){
                        this.opts.push(cell_data);
                    }

                    if(isLinked &amp;&amp; tf.disableExcludedOptions){
                        let filteredCol = filteredDataCol[j];
                        if(!filteredCol){
                            filteredCol = tf.getFilteredDataCol(j);
                        }
                        if(!Arr.has(filteredCol, cell_string, matchCase) &amp;&amp;
                            !Arr.has(
                                excludedOpts, cell_string, matchCase)){
                            excludedOpts.push(cell_data);
                        }
                    }
                }//if colIndex==j
            }//for j
        }//for k

        //Retrieves custom values
        if(this.isCustom){
            let customValues = tf.getCustomOptions(colIndex);
            this.opts = customValues[0];
            this.optsTxt = customValues[1];
        }

        if(tf.sortSlc &amp;&amp; !this.isCustom){
            if (!matchCase){
                this.opts.sort(Sort.ignoreCase);
                if(excludedOpts){
                    excludedOpts.sort(Sort.ignoreCase);
                }
            } else {
                this.opts.sort();
                if(excludedOpts){ excludedOpts.sort(); }
            }
        }

        //asc sort
        if(tf.sortNumAsc.indexOf(colIndex) != -1){
            try{
                this.opts.sort(Sort.numSortAsc);
                if(excludedOpts){
                    excludedOpts.sort(Sort.numSortAsc);
                }
                if(this.isCustom){
                    this.optsTxt.sort(Sort.numSortAsc);
                }
            } catch(e) {
                throw new Error(SORT_ERROR.replace(&apos;{0}&apos;, colIndex)
                    .replace(&apos;{1}&apos;, &apos;ascending&apos;));
            }//in case there are alphanumeric values
        }
        //desc sort
        if(tf.sortNumDesc.indexOf(colIndex) != -1){
            try{
                this.opts.sort(Sort.numSortDesc);
                if(excludedOpts){
                    excludedOpts.sort(Sort.numSortDesc);
                }
                if(this.isCustom){
                    this.optsTxt.sort(Sort.numSortDesc);
                }
            } catch(e) {
                throw new Error(SORT_ERROR.replace(&apos;{0}&apos;, colIndex)
                    .replace(&apos;{1}&apos;, &apos;ascending&apos;));
            }//in case there are alphanumeric values
        }

        //populates drop-down
        this.addOptions(colIndex, slc, isLinked, excludedOpts);

        this.emitter.emit(&apos;after-populating-filter&apos;, tf, colIndex, slc);
    }

    /**
     * Add drop-down options
     * @param {Number} colIndex     Column index
     * @param {Object} slc          Select Dom element
     * @param {Boolean} isLinked    Enable linked refresh behaviour
     * @param {Array} excludedOpts  Array of excluded options
     */
    addOptions(colIndex, slc, isLinked, excludedOpts){
        let tf = this.tf,
            slcValue = slc.value;

        slc.innerHTML = &apos;&apos;;
        slc = this.addFirstOption(slc);

        for(let y=0; y&lt;this.opts.length; y++){
            if(this.opts[y]===&apos;&apos;){
                continue;
            }
            let val = this.opts[y]; //option value
            let lbl = this.isCustom ? this.optsTxt[y] : val; //option text
            let isDisabled = false;
            if(isLinked &amp;&amp; tf.disableExcludedOptions &amp;&amp;
                Arr.has(
                    excludedOpts,
                    Str.matchCase(val, tf.matchCase),
                    tf.matchCase
                )){
                isDisabled = true;
            }

            let opt;
            //fill select on demand
            if(tf.loadFltOnDemand &amp;&amp; slcValue===this.opts[y] &amp;&amp;
                tf.getFilterType(colIndex) === tf.fltTypeSlc){
                opt = Dom.createOpt(lbl, val, true);
            } else {
                opt = Dom.createOpt(lbl, val, false);
            }
            if(isDisabled){
                opt.disabled = true;
            }
            slc.appendChild(opt);
        }// for y

        slc.setAttribute(&apos;filled&apos;, &apos;1&apos;);
    }

    /**
     * Add drop-down header option
     * @param {Object} slc Select DOM element
     */
    addFirstOption(slc){
        let tf = this.tf;

        let opt0 = Dom.createOpt(
            (!this.enableSlcResetFilter ? &apos;&apos; : tf.displayAllText),&apos;&apos;);
        if(!this.enableSlcResetFilter){
            opt0.style.display = &apos;none&apos;;
        }
        slc.appendChild(opt0);
        if(tf.enableEmptyOption){
            let opt1 = Dom.createOpt(tf.emptyText, tf.emOperator);
            slc.appendChild(opt1);
        }
        if(tf.enableNonEmptyOption){
            let opt2 = Dom.createOpt(tf.nonEmptyText, tf.nmOperator);
            slc.appendChild(opt2);
        }
        return slc;
    }

    /**
     * Select filter options programmatically
     * @param  {Number} colIndex Column index
     * @param  {Array}  values   Array of option values to select
     */
    selectOptions(colIndex, values=[]){
        let tf = this.tf;
        if(tf.getFilterType(colIndex) !== tf.fltTypeMulti ||
            values.length === 0){
            return;
        }
        let slc = tf.getFilterElement(colIndex);
        [].forEach.call(slc.options, (option)=&gt; {
            // Empty value means clear all selections and first option is the
            // clear all option
            if(values[0] === &apos;&apos; || option.value === &apos;&apos;){
                option.selected = false;
            }

            if(option.value !== &apos;&apos; &amp;&amp;
                Arr.has(values, option.value, true)){
                option.selected = true;
            }//if
        });
    }

    destroy(){
        this.emitter.off(
            [&apos;build-select-filter&apos;],
            (colIndex, isLinked, isExternal)=&gt;
                this.build(colIndex, isLinked, isExternal)
        );
        this.emitter.off(
            [&apos;select-options&apos;],
            (tf, colIndex, values)=&gt; this.selectOptions(colIndex, values)
        );
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.5)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
